---
title: "Supplemental Methods: anvi'o"
author:
  - Tommy Tran, (KLemonLab) Tommy.Tran@bcm.edu
  - Ari Roberts, (KLemonLab) Ari.Roberts@bcm.edu
  - Isabel Escapa, (KLemonLab) Isabel.FernandezEscapa@bcm.edu
output:
  rmdformats::robobook:
    use_bookdown: true
    code_folding: show
bibliography: referencesAnvio.bib
---

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(c('r', 'bash'))
```

```{r libraries, echo=FALSE, message=FALSE}
library(tidyverse)
library(viridis)
```

This notebook contains analyses using anvi'o version 8 [@Eren2021] (development branch). For more in-depth information about anvi'o go to their official online site here: <https://anvio.org/>

# Functional annotations

We use as input (`path_i`) the anvi'o contigs database files (`.db`) that were generated in [[SupplementalMethods_Prokka_Annotations]{.underline}](SupplementalMethods_Prokka_Annotations.html).

## COG annotation

First we downloaded and set up the NCBI's Clusters of Orthologous Groups database[@Tatusov2000, @Galperin2021] using `anvi-setup-ncbi-cogs`. The default is the latest version, which is COG20, meaning that anvi'o will use the NCBI's 2020 release of COGs to setup the database.

The `anvi-run-ncbi-cogs` command was used to annotate the contig databases. We used DIAMOND as searching method[@buchfink2014] with the recommended "sensitive" option.

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"

for file in $path_i/*.db; do
    anvi-run-ncbi-cogs -T 8 --search-with diamond -c $file;
done
```

## KEGG annotation

First we downloaded and set up the KEGG KOfam[@Kanehisa2000; @Kanehisa2023] database using `anvi-setup-kegg-data`. We used the snapshot of the KEGG database dated 2023-09-22 (hash a2b5bde358bb). It contains 479 modules with 15116 entries.

The program `anvi-run-kegg-kofams` annotates genes in a given anvi'o contigs database with KEGG Orthology (KO) numbers via hits to the KEGG KOfam database. We used `-E` lower than 1e-15.

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"

for file in $path_i/*.db; do
    anvi-run-kegg-kofams -T 8 --log-bitscores -E 1e-15 --just-do-it -c $file;
done
```

The option `--log-bitscores` records the bit scores values. They get saved to the main folder for the repo, so we moved them to a new subfolder

```{r, eval = FALSE}
path_i <- "."
path_o <- "data/Anvio8/KEGG_bitscores"
dir.create(file.path("data/Anvio8/KEGG_bitscores"), recursive = TRUE, showWarnings=FALSE)
files_to_move <- list.files(path_i, pattern = "_bitscores.txt$", full.names = TRUE)

for (file in files_to_move) {
  new_path <- file.path(path_o, basename(file))
  print(new_path)
  file.rename(file, new_path)
}
```

## PFAM annotation

First you need to download and set up the PFAM database[@Bateman2000; @Mistry2021] using `anvi-setup-pfams`: this is something you will do only once. We used Pfam version 36.0 (2023-07).

The program `anvi-run-kegg-pfam` annotates genes in a given anvi'o contigs database with the PFAM database.

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"

for file in $path_i/*.db; do
    anvi-run-pfams -T 8 -c $file;
done
```

## Running HMMs

When you run the following command the occurrence of bacterial single-copy genes across your contigs is added to your contigs database [@Eddy2011].

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"

for file in $path_i/*.db; do
    anvi-run-hmms -T 8 -c $file --just-do-it;
done
```

## Running CAZyme

First you need to download and set up the CAZyme database [@drula2021] using `anvi-setup-cazymes`: this is something you will do only once. We used Pfam version 11.

The program `anvi-run-cazymes` annotates genes in your contigs-db with the dbCAN CAZyme database.

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"

for file in $path_i/*.db; do
    anvi-run-cazymes -T 8 -c $file;
done
```

## Annotation Summaries

This generates basic stats on the annotations:

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"
path_o="data/Anvio8/Annotation_summaries"
mkdir -p "$path_o"

for file in $path_i/*.db; do
    FILENAME=`basename ${file%.*}`
    anvi-display-contigs-stats $file --report-as-text -o $path_o/stats_$FILENAME.txt;
done
```

This provides basic info on the contigs databases:

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Contigs_db"
path_o="data/Anvio8/Annotation_summaries"

for file in $path_i/*.db; do
    anvi-db-info $file &>> $path_o/anvi-db-info_log.txt;
done
```

# Pangenome Analysis

## Generating an anvi'o genomes storage database

The program `anvi-gen-genomes-storage` requires a `.txt` file with the names and path locations of the genomes to be included in the genome storage database. The storage database generated with `CorPGA_Anvio_GenomeList_v01a.txt` includes the 104 *Corynebacterium* genomes selected for pangenomic analysis (The three *C. macginleyi* genomes were excluded).

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Pangenomic_Analysis"
mkdir -p "$path_i"

anvi-gen-genomes-storage -e "data/genome_lists/CorPGA_Anvio_GenomeList_v01a.txt" -o $path_i/CorPGA-All4Cor-GENOMES.db --gene-caller Prodigal
```

This provides basic info on the generated genomes storage database:

```{bash, eval = FALSE}
#conda activate anvio-dev

anvi-db-info $path_i/CorPGA-All4Cor-GENOMES.db
```

## Running the pangenomic analyses

In order to analyze the pangenome individually for each of the four *Corynebacterium* species we created a `.txt` file including the list of genomes for each species and ran `anvi-pan-genome` with the `-G` flag:

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Pangenomic_Analysis"
path_g="data/genome_lists"

anvi-pan-genome -g $path_i/CorPGA-All4Cor-GENOMES.db \
                -G $path_g/CorPGA_Anvio_GenomeList_PangenomeCpr.txt \
                -o $path_i/Only_Cpr -n PAN_Cpr \
                --use-ncbi-blast --mcl-inflation 10  --num-threads 8
                
anvi-pan-genome -g $path_i/CorPGA-All4Cor-GENOMES.db \
                -G $path_g/CorPGA_Anvio_GenomeList_PangenomeCps.txt \
                -o $path_i/Only_Cps -n PAN_Cps \
                --use-ncbi-blast --mcl-inflation 10  --num-threads 8

anvi-pan-genome -g $path_i/CorPGA-All4Cor-GENOMES.db \
                -G $path_g/CorPGA_Anvio_GenomeList_PangenomeCac.txt \
                -o $path_i/Only_Cac -n PAN_Cac \
                --use-ncbi-blast --mcl-inflation 10  --num-threads 8
                
anvi-pan-genome -g $path_i/CorPGA-All4Cor-GENOMES.db \
                -G $path_g/CorPGA_Anvio_GenomeList_PangenomeCtu.txt \
                -o $path_i/Only_Ctu -n PAN_Ctu \
                --use-ncbi-blast --mcl-inflation 10  --num-threads 8                
```

## Displaying the pangenomes

This will display the pangenome in your default internet browser. Anvi'o says google chrome is the most compatible with the anvi'o interactive interface. You need to pick one of the `-p` inputs for each PAN.db file:

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Pangenomic_Analysis"

anvi-display-pan -p $path_i/Only_Cpr/PAN_Cpr-PAN.db -g $path_i/CorPGA-All4Cor-GENOMES.db

anvi-display-pan -p $path_i/Only_Cps/PAN_Cps-PAN.db -g $path_i/CorPGA-All4Cor-GENOMES.db

anvi-display-pan -p $path_i/Only_Cac/PAN_Cac-PAN.db -g $path_i/CorPGA-All4Cor-GENOMES.db

anvi-display-pan -p $path_i/Only_Ctu/PAN_Ctu-PAN.db -g $path_i/CorPGA-All4Cor-GENOMES.db
```

If you are using Windows and it cannot display the interactive page then try copy and pasting either 127.0.0.1:8080 or <http://localhost:8080/> into your browser. Do not use sudo in the front of the command either.

Once it opens in the browser, you can adjust image settings and click the "DRAW" icon to view it. For help using the interactive interface see <http://merenlab.org/2016/02/27/the-anvio-interactive-interface/>

We manually reordered the layers to match the phylogenomic trees per species using the click and drag option on the interactive interface. The order names is inverse to the layers in the concentric diagram. When all the layers were re-ordered to match the phylogenomic tree we clicked the draw button and saved the svg file.

## Creating bin collections

### Core vs. Accessory

In order to define the Core vs Accessory pangenome for each of the four species level pangenomes we use anvi'o interactive interface. In the "Bins" tab we created the corresponding bins. Using the "Search" tab we used "Search gene clusters using filters" and "Append splits to selected bin" to create bins. The following tables summarizes how the bins in the collection named **CorevsAccessory** were created (last column indicates the criteria used on each search):

#### *C. propinquum* pangenome

| Pangenome Bin    | \# of Gene Clusters/Pangenome | Percentage                    | Gene Cluster occurs in \# of genomes |
|------------------|------------------|------------------|-------------------|
| Core             | 1824/3108                     | `r round(100*(1824/3108),1)`% | 19                                   |
| Single Copy Core | 1715/3108                     | `r round(100*(1715/3108),1)`% | 19                                   |
| Multicopy Core   | 109/3108                      | `r round(100*(109/3108),1)`%  | 19                                   |
| Soft Core        | 39/3108                       | `r round(100*(39/3108),1)`%   | 18                                   |
| Shell            | 689/3108                      | `r round(100*(689/3108),1)`%  | 3-17                                 |
| Cloud            | 556/3108                      | `r round(100*(556/3108),1)`%  | 1-2                                  |

#### *C. pseudodiphtheriticum* pangenome

| Pangenome Bin    | \# of Gene Clusters/Pangenome | Percentage                    | Gene Cluster occurs in \# of genomes |
|------------------|------------------|------------------|-------------------|
| Core             | 1714/3590                     | `r round(100*(1714/3590),1)`% | 43                                   |
| Single Copy Core | 1488/3590                     | `r round(100*(1488/3590),1)`% | 43                                   |
| Multicopy Core   | 226/3590                      | `r round(100*(226/3590),1)`%  | 43                                   |
| Soft Core        | 46/3590                       | `r round(100*(46/3590),1)`%   | 40-42                                |
| Shell            | 972/3590                      | `r round(100*(972/3590),1)`%  | 3-39                                 |
| Cloud            | 858/3590                      | `r round(100*(858/3590),1)`%  | 1-2                                  |

#### *C. accolens* pangenome

| Pangenome Bin    | \# of Gene Clusters/Pangenome | Percentage                    | Gene Cluster occurs in \# of genomes |
|------------------|------------------|------------------|-------------------|
| Core             | 1904/3427                     | `r round(100*(1904/3427),1)`% | 34                                   |
| Single Copy Core | 1734/3427                     | `r round(100*(1734/3427),1)`% | 34                                   |
| Multicopy Core   | 170/3427                      | `r round(100*(170/3427),1)`%  | 34                                   |
| Soft Core        | 77/3427                       | `r round(100*(77/3427),1)`%   | 32-33                                |
| Shell            | 676/3427                      | `r round(100*(676/3427),1)`%  | 3-31                                 |
| Cloud            | 770/3427                      | `r round(100*(770/3427),1)`%  | 1-2                                  |

#### *C. tuberculostearicum* pangenome

| Pangenome Bin    | \# of Gene Clusters/Pangenome | Percentage                    | Gene Cluster occurs in \# of genomes |
|------------------|------------------|------------------|-------------------|
| Core             | 1915/2907                     | `r round(100*(1915/2907),1)`% | 8                                    |
| Single Copy Core | 1860/2907                     | `r round(100*(1860/2907),1)`% | 8                                    |
| Multicopy Core   | 55/2907                       | `r round(100*(55/2907),1)`%   | 8                                    |
| Soft Core        | 47/2907                       | `r round(100*(47/2907),1)`%   | 7                                    |
| Shell            | 270/2907                      | `r round(100*(270/2907),1)`%  | 3-6                                  |
| Cloud            | 671/2907                      | `r round(100*(671/2907),1)`%  | 1-2                                  |

### PPanGGOLiN Partitions

PPanGGOLiN partitions were imported as a collection of bins named **PPanGGOLiNpartitions** as described in [PPanGGOLiN analysis](https://klemonlab.github.io/CorPGA_Pangenomics/SupplementalMethods_PPanGGOLiN.html).

## Summarizing the pangenome files

Using the program `anvi-summarize` we exported summary tables for each of the four species level pangenomes.

The resulting summaries contain a `gene_clusters_summary.txt.gz` file that links each gene to gene clusters, genomes, functions, layers, and bins selected from the interface. We used the flag `-C` to selected the **CorevsAccessory** collection described above:

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Pangenomic_Analysis"

anvi-summarize -p $path_i/Only_Cpr/PAN_Cpr-PAN.db \
               -g $path_i/CorPGA-All4Cor-GENOMES.db \
               -o $path_i/Only_Cpr/Summaries \
               -C CorevsAccessory

anvi-summarize -p $path_i/Only_Cps/PAN_Cps-PAN.db \
               -g $path_i/CorPGA-All4Cor-GENOMES.db \
               -o $path_i/Only_Cps/Summaries \
               -C CorevsAccessory
               
anvi-summarize -p $path_i/Only_Cac/PAN_Cac-PAN.db \
               -g $path_i/CorPGA-All4Cor-GENOMES.db \
               -o $path_i/Only_Cac/Summaries \
               -C CorevsAccessory

anvi-summarize -p $path_i/Only_Ctu/PAN_Ctu-PAN.db \
               -g $path_i/CorPGA-All4Cor-GENOMES.db \
               -o $path_i/Only_Ctu/Summaries \
               -C CorevsAccessory
```

The output files were used for the COG functional analysis based on PPanGGOLiN partitions.

# Metabolic Enrichment Analysis

## Estimation of KEGG module completeness

Using `anvi-estimate-metabolism` we predicted KEGG module completeness as described in [@kanehisa2011a] for the the organisms listed in `CorPGA_MetabolicAnalysis_GenomeList_v01.txt`. This list includes:

-   The 102 *Corynebacterium* genomes selected for metabolic analysis (Cac_ATCC_49726 & Cps_090104 were excluded for this analysis, as well as all three *C. macginleyi* genomes)
-   Plus 27 for the 28 *Dolosigranulum pigrum* genomes described in [@floresramos2021] (KPL3086 was not included in the analysis due to being highly similar to KPL3065).
-   As well as the 9 reference genomes with original NCBI annotations listed in Table S5.

We generated outputs both in long tabular and matrix format with the KO hits and KEGG modules completeness scores.

```{bash, eval = FALSE}
#conda activate anvio-dev

mkdir -p "data/Anvio8/Metabolic_Analysis"
path_o="data/Anvio8/Metabolic_Analysis"

txt_file="data/genome_lists/CorPGA_MetabolicAnalysis_GenomeList_v01.txt"
prefix=CorPGA
path_o="data/Anvio8/Metabolic_Analysis"
mkdir -p "$path_o"

anvi-estimate-metabolism -e $txt_file \
                         -O $path_o/$prefix --matrix-format --include-metadata

anvi-estimate-metabolism -e $txt_file \
                         -O $path_o/$prefix --add-copy-number --output-modes modules,module_paths,module_steps,hits 
```

## Module Enrichment Analysis

The `CorPGA_modules.txt` file generated in the previous step is used by `anvi-compute-metabolic-enrichment` to calculate KEGG module enrichment[@shaiber2020] across different groups of genomes. We used the `-G` flag to indicate the grouping options defined in the corresponding `txt_file`:

-   `CorPGA_MetabolicAnalysis_Groups_4Cor.txt`includes 102 genomes for the 4 nasal *Corynebacterium* grouped by their species.

-   `CorPGA_MetabolicAnalysis_Groups_CorDpi.txt` adds to the previous file an extra group with the 27 *D. pigrum* genomes.

-   `CorPGA_MetabolicAnalysis_Groups_Cps.txt` includes the 41 *C. pseudodiphtheriticum* genomes selected to study metabolic differences across geographic locations (BWA vs. USA grouping).

-   `CorPGA_MetabolicAnalysis_Groups_References.txt` adds to the previous file the 9 NCBI reference genomes as 9 new groups.

```{bash, eval = FALSE}
#conda activate anvio-dev

csv_file_modules="data/Anvio8/Metabolic_Analysis/CorPGA_modules.txt"
path_o="data/Anvio8/Metabolic_Analysis/Enrichment_Modules"
mkdir -p "$path_o"

txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_4Cor.txt"
output_file="$path_o/CorPGA_enriched_modules_stepwise_1_4Cor.txt"
anvi-compute-metabolic-enrichment -M "$csv_file_modules" \
                                  -G "$txt_file_groups" \
                                  -o "$output_file" \
                                  --use-stepwise-completeness \
                                  --module-completion-threshold 1.0


txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_CorDpi.txt"
output_file="$path_o/CorPGA_enriched_modules_stepwise_1_CorDpi.txt"
anvi-compute-metabolic-enrichment -M "$csv_file_modules" \
                                  -G "$txt_file_groups" \
                                  -o "$output_file" \
                                  --use-stepwise-completeness \
                                  --module-completion-threshold 1.0

txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_Cps.txt"
output_file="$path_o/CorPGA_enriched_modules_stepwise_1_Cps.txt"
anvi-compute-metabolic-enrichment -M "$csv_file_modules" \
                                  -G "$txt_file_groups" \
                                  -o "$output_file" \
                                  --use-stepwise-completeness \
                                  --module-completion-threshold 1.0
                                  
txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_References.txt"
output_file="$path_o/CorPGA_enriched_modules_stepwise_1_References.txt"
anvi-compute-metabolic-enrichment -M "$csv_file_modules" \
                                  -G "$txt_file_groups" \
                                  -o "$output_file" \
                                  --use-stepwise-completeness \
                                  --module-completion-threshold 1.0
```

## KO Enrichment Analysis

We use `anvi-display-functions`. It runs the enrichment for the desired annotations (in this case KOfam). It saves the output to a temp file that can be recovered, renamed and saved into the same `path_o` as the database file.

```{bash, eval = FALSE}

#conda activate anvio-dev

txt_file="data/genome_lists/CorPGA_MetabolicAnalysis_GenomeList_v01.txt"
path_o="data/Anvio8/Metabolic_Analysis/Enrichment_KOs"
mkdir -p "$path_o"

txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_4Cor.txt"
anvi-display-functions -e $txt_file \
                       --groups-txt $txt_file_groups \
                       --annotation-source KOfam \
                       --profile-db $path_o/KOfam_4Cor.db
                       
txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_CorDpi.txt"
anvi-display-functions -e $txt_file \
                       --groups-txt $txt_file_groups \
                       --annotation-source KOfam \
                       --profile-db $path_o/KOfam_CorDpi.db    
                       
txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_Cps.txt"
anvi-display-functions -e $txt_file \
                       --groups-txt $txt_file_groups \
                       --annotation-source KOfam \
                       --profile-db $path_o/KOfam_Cps.db

txt_file_groups="data/genome_lists/CorPGA_MetabolicAnalysis_Groups_References.txt"
anvi-display-functions -e $txt_file \
                       --groups-txt $txt_file_groups \
                       --annotation-source KOfam \
                       --profile-db $path_o/KOfam_References.db  
```

Many of the enriched KOs belong to the already identified enriched modules. This function filters out those KOs that are part of the definition of modules listed in the enriched modules identified with `anvi-compute-metabolic-enrichment`:

```{r, eval = FALSE}
get_KOs_not_in_enrich_modules <- function(modules, hits, enrich_modules, enrich_KOs, q_value_threshold) {

  # Get list of KOs that correspond with the modules on the enrichment file
  modules_subset <- modules %>% filter(module %in% enrich_modules$accession)
  module_definition_subset <- paste(modules_subset$module_definition, collapse = " ")
  module_definition_subset <- str_extract_all(module_definition_subset, "\\bK\\d+\\b")
  module_definition_subset <- unique(unlist(module_definition_subset))

  # Add a column to enrich_KOs indicating if the KO is the previous list
  enrich_KOs$inModule <- sapply(strsplit(as.character(enrich_KOs$accession), ","), function(x) all((x %in% module_definition_subset)))

  # Filter Enrich_KO based on inModule and q_value_threshold
  enrich_KOs_filtered <- enrich_KOs %>% 
    filter(inModule == FALSE) %>% 
    filter(adjusted_q_value < q_value_threshold)

  return(enrich_KOs_filtered)
}

Modules <- read_delim("data/Anvio8/Metabolic_Analysis/CorPGA_modules.txt", show_col_types = FALSE, col_types = cols(unique_enzymes_hit_counts = col_character(), gene_caller_ids_in_module = col_character()))
KOHits <- read_delim("data/Anvio8/Metabolic_Analysis/CorPGA_hits.txt", show_col_types = FALSE)

Enrich_Mod_4Cor <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_Modules/CorPGA_enriched_modules_stepwise_1_4Cor.txt", show_col_types = FALSE)
Enrich_KO_4Cor <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_4Cor.txt", show_col_types = FALSE)
Enrich_KO_4Cor_Filtered <- get_KOs_not_in_enrich_modules(Modules, KOHits, Enrich_Mod_4Cor, Enrich_KO_4Cor, 0.1)
write_csv(Enrich_KO_4Cor_Filtered, "data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_4Cor_Filtered.csv")

Enrich_Mod_CorDpi <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_Modules/CorPGA_enriched_modules_stepwise_1_CorDpi.txt", show_col_types = FALSE)
Enrich_KO_CorDpi <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_CorDpi.txt", show_col_types = FALSE)
Enrich_KO_CorDpi_Filtered <- get_KOs_not_in_enrich_modules(Modules, KOHits, Enrich_Mod_CorDpi, Enrich_KO_CorDpi, 0.1)
write_csv(Enrich_KO_CorDpi_Filtered, "data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_CorDpi_Filtered.csv")

Enrich_Mod_Cps <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_Modules/CorPGA_enriched_modules_stepwise_1_Cps.txt", show_col_types = FALSE)
Enrich_KO_Cps <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_Cps.txt", show_col_types = FALSE)
Enrich_KO_Cps_Filtered <- get_KOs_not_in_enrich_modules(Modules, KOHits, Enrich_Mod_Cps, Enrich_KO_Cps, 0.1)
write_csv(Enrich_KO_Cps_Filtered, "data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_Cps_Filtered.csv")

Enrich_Mod_References <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_Modules/CorPGA_enriched_modules_stepwise_1_References.txt", show_col_types = FALSE)
Enrich_KO_References <- read_delim("data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_References.txt", show_col_types = FALSE)
Enrich_KO_References_Filtered <- get_KOs_not_in_enrich_modules(Modules, KOHits, Enrich_Mod_References, Enrich_KO_References, 0.1)
write_csv(Enrich_KO_References_Filtered, "data/Anvio8/Metabolic_Analysis/Enrichment_KOs/CorPGA_enriched_KOs_References_Filtered.csv")
```

## Distribution Plots

```{r, eval = FALSE}
Modules_Distributions <- Modules %>% 
  filter(!grepl("^GCF", genome_name)) %>%
  #filter(module_class=="Pathway modules") %>%
  mutate(species_name = str_extract(genome_name, "^[^_]+")) %>%
  unite(modules_label, c(module_category, module_subcategory), sep = "_", remove = FALSE) %>% 
  select(species_name, genome_name, module, module_name, module_category, module_subcategory, modules_label, stepwise_module_completeness, pathwise_module_completeness) %>% 
  mutate_at(c("species_name", "genome_name", "module", "module_name", "module_category", "module_subcategory", "modules_label"), factor)

Modules_Distributions_Means = Modules_Distributions %>% 
  group_by(modules_label, genome_name, .drop=FALSE) %>%
  summarise(mean_stepwise_module_completeness=mean(stepwise_module_completeness)) %>%
  mutate(mean_stepwise_module_completeness = coalesce(mean_stepwise_module_completeness, 0)) %>%
  mutate(species_name = str_extract(genome_name, "^[^_]+")) %>%
  mutate(module_category = str_extract(modules_label, "^[^_]+")) %>%
  mutate(modules_final_label = str_replace(modules_label, "^[^_]+_", "")) %>%
  mutate_at(c("module_category", "modules_final_label"), factor)
```

```{r eval = FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=20}
plot <- ggplot(Modules_Distributions_Means, aes(x=genome_name, y=modules_final_label, fill=mean_stepwise_module_completeness)) + 
  geom_tile(color = "white") +
  facet_grid(module_category ~ species_name, drop = TRUE, scales = "free", space = "free") + 
  labs(x="", y="") +
  scale_y_discrete(expand=c(0, 0)) +
  scale_fill_viridis(direction = -1, option = "A", begin = 0.2) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_text(angle = 0, hjust = 0),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="top") +
  guides(fill = guide_colourbar(title="Average step module completeness"))

plot
ggsave(plot = plot, filename = "data/Anvio8/Metabolic_Analysis/plots/plot2.jpg", height = 10, width = 20, device ='jpg', dpi = 500)
```


## Pangenomic level analysis

This list includes a total of 103 genomes: the 102 *Corynebacterium* genomes selected for metabolic analysis (Cac_ATCC_49726 & Cps_090104 were excluded for this analysis) plus *C glutamicum* ATCC 13032 [GCF_000011325.1](https://www.ncbi.nlm.nih.gov/nuccore/NC_003450.3).

```{bash, eval = FALSE}
#conda activate anvio-dev

path_i="data/Anvio8/Pangenomic_Analysis"

anvi-gen-genomes-storage -e "data/genome_lists/CorPGA_Anvio_GenomeList_v01b.txt" -o $path_i/CorPGA-All4CorCgl-GENOMES.db --gene-caller Prodigal

anvi-db-info $path_i/CorPGA-All4CorCgl-GENOMES.db

anvi-pan-genome -g $path_i/CorPGA-All4CorCgl-GENOMES.db \
                -o $path_i/All4CorCgl -n PAN_All4CorCgl \
                --use-ncbi-blast --mcl-inflation 10  --num-threads 8 --I-know-this-is-not-a-good-idea
                
#Create a bin collection named All4CorCgl with all Core GCs for the 5 species using the visual interface:       

anvi-display-pan -p $path_i/All4CorCgl/PAN_All4CorCgl-PAN.db -g $path_i/CorPGA-All4CorCgl-GENOMES.db         

anvi-summarize -p $path_i/All4CorCgl/PAN_All4CorCgl-PAN.db \
               -g $path_i/CorPGA-All4CorCgl-GENOMES.db \
               -o $path_i/All4CorCgl/Summaries \
               -C All4CorCgl
```

```{r}
fasta_file_for_GC <- function(Summary, GC, output_path) {
  data <- Summary %>% 
    filter(gene_cluster_id == GC) %>% 
    mutate(fasta_lines = paste0(">", gene_cluster_id, "|", genome_name, "|callers_id:", gene_callers_id, "\n", aa_sequence))
  
  if (!file.exists(output_path)) {
    dir.create(output_path, recursive = TRUE)
  }
  output_fasta <- file.path(output_path, paste0(GC, ".fasta"))
  output_csv <- file.path(output_path, paste0(GC, ".csv"))
  
  writeLines(data$fasta_lines, con = output_fasta)
  write_csv(data, file = output_csv)

  cat(GC, "files created with a total of", nrow(data), "aa sequences. \n")
  return(data)
}

Summary <- read_delim("data/Anvio8/Pangenomic_Analysis/All4CorCgl/Summaries/PAN_All4CorCgl_gene_clusters_summary.txt.gz", show_col_types = FALSE)

output_path <- "data/Anvio8/Metabolic_Analysis/GC_fastas"
output <- fasta_file_for_GC(Summary, "GC_00000328", output_path) #glnA
output <- fasta_file_for_GC(Summary, "GC_00000120", output_path) #gdhA
output <- fasta_file_for_GC(Summary, "GC_00000515", output_path) #ilvA

output <- fasta_file_for_GC(Summary, "GC_00000166", output_path) #aroT
output <- fasta_file_for_GC(Summary, "GC_00000814", output_path) #aspT
output <- fasta_file_for_GC(Summary, "GC_00000680", output_path) #serC
output <- fasta_file_for_GC(Summary, "GC_00000732", output_path) #dapC
output <- fasta_file_for_GC(Summary, "GC_00000889", output_path) #argD
output <- fasta_file_for_GC(Summary, "GC_00000164", output_path) #hisC
output <- fasta_file_for_GC(Summary, "GC_00000699", output_path) #ilvE
output <- fasta_file_for_GC(Summary, "GC_00000782", output_path) #metC
output <- fasta_file_for_GC(Summary, "GC_00006799", output_path) #avtA
output <- fasta_file_for_GC(Summary, "GC_00000648", output_path) #alaT

output <- fasta_file_for_GC(Summary, "GC_00000656", output_path) #hisB

output <- fasta_file_for_GC(Summary, "GC_00000985", output_path) #argC
output <- fasta_file_for_GC(Summary, "GC_00000984", output_path) #argJ
output <- fasta_file_for_GC(Summary, "GC_00000986", output_path) #argB
output <- fasta_file_for_GC(Summary, "GC_00000889", output_path) #argD

output <- fasta_file_for_GC(Summary, "GC_00001785", output_path) #UreA
output <- fasta_file_for_GC(Summary, "GC_00001786", output_path) #UreB
output <- fasta_file_for_GC(Summary, "GC_00001789", output_path) #UreC
output <- fasta_file_for_GC(Summary, "GC_00006375", output_path) #UreE
output <- fasta_file_for_GC(Summary, "GC_00006213", output_path) #UreF Cgl
output <- fasta_file_for_GC(Summary, "GC_00001796", output_path) #UreF 
output <- fasta_file_for_GC(Summary, "GC_00001776", output_path) #UreG
output <- fasta_file_for_GC(Summary, "GC_00005747", output_path) #UreD Cgl
output <- fasta_file_for_GC(Summary, "GC_00001801", output_path) #UreD
```

## Blast Validations

```{bash}
#| eval: FALSE

path_o="data/Anvio8/Metabolic_Analysis/Blast_Validations/Databases"
mkdir -p "$path_o"

path_i="data/Anvio8/Prokka_out/"
./scripts/process_files_forblastDB.sh $path_i .fna $path_o "NovCor_FullSequence"
./scripts/process_files_forblastDB.sh $path_i .ffn $path_o "NovCor_Annotated_nt"
./scripts/process_files_forblastDB.sh $path_i .faa $path_o "NovCor_Annotated_aa"

path_i="data/Anvio8/Parsed_NCBI/"
./scripts/process_files_forblastDB.sh $path_i .fa $path_o "NCBIStrains_FullSequence"
```

The directory "data/Anvio8/Metabolic_Analysis/NovCor_v03/Blast_Validations/Databases" had to be moved out of Box for the makeblastdb command to work

```{bash}
#| eval: FALSE

#cd <local/path/Blast_Validations/Databases>

makeblastdb -in NovCor_FullSequence -title "NovCor_FullSequence" -input_type fasta -parse_seqids -dbtype 'nucl'
makeblastdb -in NovCor_Annotated_nt -title "NovCor_Annotated_nt" -input_type fasta -parse_seqids -dbtype 'nucl'
makeblastdb -in NovCor_Annotated_aa -title "NovCor_Annotated_aa" -input_type fasta -parse_seqids -dbtype 'prot'

makeblastdb -in NCBIStrains_FullSequence -title "NCBIStrains_FullSequence" -input_type fasta -parse_seqids -dbtype 'nucl'
```

```{bash}
#| eval: FALSE

path_o="data/Anvio8/Metabolic_Analysis/Blast_Validations"

tblastn -db $path_o/Databases/NovCor_FullSequence \
        -query $path_o/Cgl_gdhA.faa \
        -out $path_o/Cgl_gdhA_vs_NovCor_FullSequence.csv \
        -outfmt "10 std qcovs delim=,"
        
tblastn -db $path_o/Databases/NovCor_Annotated_nt \
        -query $path_o/Cgl_gdhA.faa \
        -out $path_o/Cgl_gdhA_vs_NovCor_Annotated_nt.csv \
        -outfmt "10 std qcovs delim=,"       

blastp -db $path_o/Databases/NovCor_Annotated_aa \
        -query $path_o/Cgl_gdhA.faa \
        -out $path_o/Cgl_gdhA_vs_NovCor_Annotated_aa.csv \
        -outfmt "10 std qcovs delim=,"  
        
tblastn -db $path_o/Databases/NCBIStrains_FullSequence \
        -query $path_o/Cgl_gdhA.faa \
        -out $path_o/Cgl_gdhA_NCBIStrains_vs_FullSequence.csv \
        -outfmt "10 std qcovs delim=,"
        
        
tblastn -db $path_o/Databases/NovCor_FullSequence \
        -query $path_o/Cgl_urease.faa \
        -out $path_o/Cgl_urease_vs_NovCor_FullSequence.csv \
        -outfmt "10 std qcovs delim=,"
        
tblastn -db $path_o/Databases/NovCor_Annotated_nt \
        -query $path_o/Cgl_urease.faa \
        -out $path_o/Cgl_urease_vs_NovCor_Annotated_nt.csv \
        -outfmt "10 std qcovs delim=,"       

blastp -db $path_o/Databases/NovCor_Annotated_aa \
        -query $path_o/Cgl_urease.faa \
        -out $path_o/Cgl_urease_vs_NovCor_Annotated_aa.csv \
        -outfmt "10 std qcovs delim=,"  
        
tblastn -db $path_o/Databases/NCBIStrains_FullSequence \
        -query $path_o/Cgl_urease.faa \
        -out $path_o/Cgl_urease_NCBIStrains_vs_FullSequence.csv \
        -outfmt "10 std qcovs delim=,"
```

```{r}
Cgl_gdhA_vs_NovCor_FullSequence <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_gdhA_vs_NovCor_FullSequence.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_gdhA_vs_NovCor_Annotated_nt <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_gdhA_vs_NovCor_Annotated_nt.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_gdhA_vs_NovCor_Annotated_aa <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_gdhA_vs_NovCor_Annotated_aa.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_gdhA_vs_NovCor_FullSequence <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_gdhA_vs_NovCor_FullSequence.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))

Cgl_urease_vs_NovCor_FullSequence <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_urease_vs_NovCor_FullSequence.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_urease_vs_NovCor_Annotated_nt <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_urease_vs_NovCor_Annotated_nt.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_urease_vs_NovCor_Annotated_aa <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_urease_vs_NovCor_Annotated_aa.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
Cgl_urease_vs_NovCor_FullSequence <- read_csv("data/Anvio8/Metabolic_Analysis/Blast_Validations/Cgl_urease_vs_NovCor_FullSequence.csv", show_col_types = FALSE, col_names = c("qaccver","saccver","pident","length","mismatch","gapopen","qstart","qend","sstart","send","evalue","bitscore","qcovs"))
```

<img src="images/Department-of-Molecular-Virology-&amp;-Microbiologyy-Horz-GRAY.png" align="left" width="200" height="90"/>

------------------------------------------------------------------------

------------------------------------------------------------------------

------------------------------------------------------------------------

------------------------------------------------------------------------

<center>

<h3>[REFERENCES]{.underline}</h3>

</center>
