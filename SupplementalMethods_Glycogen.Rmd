---
title: "Supplemental Methods: Glycogen"
author: 
- Tommy Tran, (KLemonLab) Tommy_Tran@alumni.baylor.edu
- Isabel Escapa, (KLemonLab) Isabel.FernandezEscapa@bcm.edu
output:
  rmdformats::robobook:
    use_bookdown: true
    code_folding: show
bibliography: references.bib
csl: references_style.csl
execute:
  message: FALSE
  warning: FALSE
---

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(c('r', 'bash'))
```

```{r}
# Load libraries
library(readxl)
library(ggpubr)
library(grid)
library(lme4)
library(afex)
library(merTools)
library(tidyverse)
```

# Wetlab Methods

This study involved a detailed procedure to analyze the growth and glycogen concentration of bacterial species. To measure glycogen the Glycogen-Gly Assay kit from Promega was used (Catalog #: J5051). The species of interest were first streaked on brain heart infusion supplemented with tween and allowed to grow for 36-48 hours. Subsequently, single colonies were picked and inoculated into tubes containing 4.5 ml of PBS buffer. The samples underwent two full washes with PBS buffer and were centrifuged at 13000 RPM at 4°C for 10 minutes each time.

The optical density at 600 nm (OD600) was measured and normalized to 2. The normalized samples were then inoculated into 50 ml nCDM + 5% glucose in 250 ml flasks and the OD600 was measured at 24, 28, 32, and 48 hours. A 4 ml aliquot from each sample was centrifuged, resuspended in PBS, and washed twice. During the washes, glycogen enzymes were thawed on ice.

After washing, the samples were resuspended in PBS and the OD600 was measured and normalized to 0.5. A 300 µl aliquot of each sample was combined with 150 µl of HCL in a bead-beating tube and heated in a non-shaking dry bath at 95°C for 5 minutes. The samples were bead-beaten three times at 6.5 m/s for 45 seconds each time. After bead-beating, 150 µl of Tris buffer was added to each tube.

The samples were then centrifuged at 16000 RCF at 4°C for 20 minutes. The supernatant was transferred to a clean tube and aliquoted into a 96-well plate. Amylase reagent was prepared and standards were transferred to the plate reader wells. The samples were incubated at room temperature for 1 hour. After incubation, a glucose detection reagent was prepared and added to the samples and controls. Luminescence was measured using a compatible plate reader. The results provide insights into the growth and glycogen concentration of the bacterial species under study.

# Individual Experiment Analysis (N=1)

The analysis was ran three different times based on three independent experiments on different dates. This data can be found in `data/glycogen` as `.xlsx` files with the following 3 tabs:
  
  - **csvOD:** contains the columns Date, Species, Strain, TimePoint, Media, Reject and GrowthOD. 
  - **csvNorm:** contains the columns Species, TimePoint, Date, and ODNorm. 
  - **csvLum:** contains the columns Date, TimePoint, Well_ID, Type, Amy, Species, Strain, Reject, Glycogen, and Lum. 

```{r}
######### Reading Data and Basic Clean-up ######### 

# Defining the experiment variable (Comment out one experiment at a time)
#experiment <- "240322_Gly"
#experiment <- "240325_Gly"
experiment <- "240331_Gly"

# Read data from an Excel file into two separate data frames: data_lum from the "csvLum" sheet and data_OD from the "csvOD" sheet
data_lum <- read_excel(file.path(paste0("data/glycogen/", experiment, ".xlsx")), sheet = "csvLum")
data_OD <- read_excel(file.path(paste0("data/glycogen/", experiment, ".xlsx")), sheet = "csvOD")
data_norm <- read_excel(file.path(paste0("data/glycogen/", experiment, ".xlsx")), sheet = "csvNorm")

# Filter out rows where "Reject" column is "F" and where "Type" column is not "Empty" in the data_lum data frame, and remove the "Reject" column for both dataframes. Remove species "Cna", as this strain was not included on the manuscript.
data_lum <- data_lum %>% 
  filter(Reject == "F") %>%
  filter(Type != "Empty") %>%
  filter(Species != "Cna") %>%
  select(-Reject)

data_OD <- data_OD %>% 
  filter(Reject == "F") %>%
  filter(Species != "Cna") %>%
  select(-Reject)

data_norm <- data_norm %>% 
  filter(Species != "Cna")

# Split the data_lum data frame into two separate data frames: data_lum_samples containing rows where "Type" is "Sample" and data_lum_standards containing rows where "Type" is "Standard", and remove unnecessary columns
data_lum_samples <- data_lum %>% 
  filter(Type == "Sample")

data_lum_standards <- data_lum %>% 
  filter(Type == "Standard") %>%
  select(-Species, -Strain)

# Convert the "Amy" column in data_lum_standards to a factor and "Glycogen" column to numeric
data_lum_standards$Amy <- as.factor(data_lum_standards$Amy)
data_lum_standards$Glycogen <- as.numeric(data_lum_standards$Glycogen)
```

```{r}
# Function to analyze a single timepoint
analyze_glycogen <- function(time, data_lum_standards, data_lum_samples) {
  # Filter the data_lum_standards data frame for rows where "TimePoint" is equal to the specified time
  time_standard <- data_lum_standards %>% 
    filter(TimePoint == time) %>%
    group_by(Glycogen) %>%
    mutate(Difference = ifelse(Amy == "T", Lum - lag(Lum), NA)) %>%
    filter(!is.na(Difference))

  # Fit a linear model (lm) for the standards with "Difference" as the dependent variable and "Glycogen" as the independent variable
  lmStandard <- lm(Difference ~ Glycogen, time_standard) 

  # Extract coefficients from the linear model
  coefficients <- lmStandard$coefficients

  # Filter the data_lum_samples data frame for rows where "TimePoint" is equal to the specified time
  time_samples <- data_lum_samples %>%
    filter(TimePoint == time) %>%
    mutate(Glycogen = (Lum - coefficients[1]) / coefficients[2])

  # Group the data by Strain and Amy, calculate the mean Lum value within each group
  time_samples_diff <- time_samples %>% 
    group_by(Species, Amy) %>%
    summarise(LumAvg = mean(Lum)) %>%
    mutate(Difference = ifelse(Amy == "T", LumAvg - lag(LumAvg), NA)) %>%
    filter(!is.na(Difference)) %>%
    mutate(Glycogen = (Difference - coefficients[1]) / coefficients[2]) %>%
    select(-Amy, -LumAvg) %>%
    mutate(TimePoint = time)

  # Adds individual IDs to the replicas, with and without Amy.
  time_samples <- time_samples %>%
    arrange(Species, Amy)
  time_samples$Replica <- as.factor(rep(1:6, length.out = nrow(time_samples)))

  return(list(time_samples_diff = time_samples_diff))
}
```

```{r}
# Loop through different values of time
all_results <- list()

for (time_point in unique(data_lum_standards$TimePoint)) {
  result <- analyze_glycogen(time_point, data_lum_standards, data_lum_samples)
  all_results[[paste0("Time_", time_point)]] <- result

# Combine all time_samples_diff dataframes into a single dataframe
full_Lum_df <- do.call(rbind, lapply(all_results, function(result) result$time_samples_diff))

full_Lum_df <- left_join(full_Lum_df, data_norm) %>%
  mutate(GlycogenNorm = Glycogen/ODNorm)
}
```

```{r}
# Convert the 'Species' column to a factor with specified levels
full_Lum_df$Species <- factor(full_Lum_df$Species, levels = c("Cpr", "Cps", "Cac", "Ctu", "Cgl"))

# Convert the 'TimePoint' column to a factor with default level ordering
full_Lum_df$TimePoint <- factor(full_Lum_df$TimePoint)

# Assign the first 'Date' value from 'data_OD' to all rows in 'full_Lum_df'
full_Lum_df$Date <- data_OD$Date[1]

# Write the 'full_Lum_df' dataframe to a CSV file, excluding row names
#write.csv(full_Lum_df, paste0("data/glycogen/Lum/", experiment,"_Lum.csv"), row.names = F)

# Write the 'data_OD' dataframe to a CSV file, excluding row names
#write.csv(data_OD, paste0("data/glycogen/OD/", experiment,"_OD.csv"), row.names = F)
```

## Saving files

```{r}
# Create subfolders for output files
Lum_folder <- "data/glycogen/Lum"
if (!file.exists("data/glycogen/Lum")) {
  dir.create("data/glycogen/Lum", recursive = TRUE)
}

OD_folder <- "data/glycogen/OD"
if (!file.exists("data/glycogen/OD")) {
  dir.create("data/glycogen/OD", recursive = TRUE)
}

# Save data frames as CSV files in their output folders
write.csv(full_Lum_df, file.path(Lum_folder, paste0(experiment, "_Lum.csv")), row.names = FALSE)
write.csv(data_OD, file.path(OD_folder, paste0(experiment, "_OD.csv")), row.names = FALSE)

# Cleaning-up all objects from the environment
rm(list = ls())
```

# Combined Analysis (N=3)

```{r}
# Define the directory path for OD data
folder_OD <- "data/glycogen/OD"

# Create a list of full file names for all '_OD.csv' files in the directory
file_list_OD <- list.files(folder_OD, pattern = "_OD.csv", full.names = TRUE)

# Read each file into a list of dataframes
df_list_OD <- lapply(file_list_OD, read.csv)

# Combine all dataframes in the list into a single dataframe
df_OD <- bind_rows(df_list_OD)

# Define the directory path for Lum data
folder_lum <- "data/glycogen/Lum"

# Create a list of full file names for all '_Lum.csv' files in the directory
file_list_lum <- list.files(folder_lum, pattern = "_Lum.csv", full.names = TRUE)

# Read each file into a list of dataframes
df_list_lum <- lapply(file_list_lum, read.csv)

# Combine all dataframes in the list into a single dataframe
df_lum <- bind_rows(df_list_lum)

# Convert the 'Species' column in all average data frames to a factor with specified levels
df_OD$Species <- factor(df_OD$Species, levels = c("Cpr", "Cps", "Cac", "Ctu", "Cgl"))
df_lum$Species <- factor(df_lum$Species, levels = c("Cpr", "Cps", "Cac", "Ctu", "Cgl"))

# Convert the 'TimePoint' column in Lum data frame to a factor with default level ordering
df_lum$TimePoint <- factor(df_lum$TimePoint)

# Define colors
species_colors <- c("#FF8C00", "#FF0000", "#6A329F", "#3B54A4", "grey50")
```

## Growth (OD600)
```{r}
# Group the OD data by Species and TimePoint, then calculate the average OD and standard error
avg_data_OD <- df_OD %>%
  group_by(Species, TimePoint) %>%
  summarise(
    AvgOD = mean(GrowthOD, na.rm = TRUE), # Calculate the average OD, removing NA values
    SE = sd(GrowthOD, na.rm = TRUE) / sqrt(sum(!is.na(GrowthOD))) # Calculate standard error
  )
```

```{r}
# Create a line plot of average OD600 over time for each species
plot_avg_OD600 <- ggplot(avg_data_OD, aes(x = TimePoint, y = AvgOD, color = Species)) +
  geom_line() + # Add lines to connect points
  geom_point(size = 2) + # Add points to represent data
  geom_errorbar(aes(ymin = AvgOD - SE, ymax = AvgOD + SE), width = 0.2) + # Add error bars
  labs(
    y = "Average OD600",
    x = "Time"
    ) +
  scale_color_manual(values = species_colors) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,2)) +
  theme_classic() + 
  theme(
    legend.position = "none", # Remove the legend
    plot.margin = margin(1, 1, 1, 1, "cm") # Adjust plot margins
  )
plot_avg_OD600
```

## Luminesce
```{r}
# Mixed linear model with GlycogenNorm as fixed effect and TimePoint as a random effect. Using "Ctu" as reference (first factor level)
df_lum$Species <- factor(df_lum$Species, levels = c("Ctu", "Cgl", "Cpr", "Cps", "Cac")) 
model <- lmer(GlycogenNorm ~ Species 
              + (1|TimePoint),
              data = df_lum)

anova(model)
summary(model)

# Model predicted confident intervals
pred <- predictInterval(model, level = 0.95, n.sims = 1000, which = "full")
df_lum_pred <- cbind(df_lum, pred)

# Group Lum data by Species and TimePoint, then calculate the all average values
avg_data_Lum <- df_lum_pred %>%
group_by(Species, TimePoint) %>%
  summarise(
    AvgLum = mean(GlycogenNorm, na.rm = TRUE), # Calculate the average normalized Glycogen, removing NA values
    SE = sd(GlycogenNorm, na.rm = TRUE) / sqrt(sum(!is.na(GlycogenNorm))), # Calculate standard error
    mean_fit = mean(fit), 
    mean_lwr = mean(lwr),
    mean_upr = mean(upr),
    .groups = 'drop')

df_lum$Species <- factor(df_lum$Species, levels = c("Cpr", "Cps", "Cac", "Ctu", "Cgl"))
```

```{r}
# Create a dot boxplot of normalized glycogen concentration over time for each species
plot_Lum <- ggplot(df_lum, aes(x = TimePoint, y = GlycogenNorm, fill = Species)) +
  geom_boxplot() + 
  labs(
    y = "Normalized Glycogen",
    x = "Time"
  ) +
  scale_fill_manual(values = species_colors) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() + 
  theme(
    plot.margin = margin(1, 1, 1, 1, "cm") # Adjust plot margins
  )
plot_Lum
```

```{r}
#Create Luminesce plot with stats
plot_Lum_Stats <- ggplot(avg_data_Lum, aes(x = TimePoint, fill = Species)) +
  geom_boxplot(aes(lower = AvgLum - SE, upper = AvgLum + SE, middle = AvgLum, ymin = mean_lwr, ymax = mean_upr), stat = "identity") +
  labs(
    y = "Normalized Glycogen",
    x = "Time"
  ) +
  scale_fill_manual(values = species_colors) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() + 
  theme(
    plot.margin = margin(1, 1, 1, 1, "cm") # Adjust plot margins
  )
plot_Lum_Stats
```

```{r}
# Create a bar plot of average normalized glycogen concentration over time for each species
plot_avg_Lum <- ggplot(avg_data_Lum, aes(x = TimePoint, y = AvgLum, fill = Species)) +
  geom_bar(position = position_dodge(), stat = "identity", color = "black") + # Add bars with dodge position
  geom_errorbar(aes(ymin = AvgLum, ymax = AvgLum + SE), position = position_dodge(width = 0.9), width = 0.2) + # Add error bars
  labs(
    y = "Average Normalized Glycogen",
    x = "Time"
    ) +
  scale_fill_manual(values = species_colors) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 13)) +
  theme_classic() + 
  theme(
    plot.margin = margin(1, 1, 1, 1, "cm")
  ) # Adjust plot margins
plot_avg_Lum
```

## Saving files

```{r}
# Combine the plots using ggarrange
combined_plot <- ggarrange(plot_avg_OD600, plot_Lum, ncol = 2, labels = c("A", "B"), widths = c(0.5, 0.5))
combined_plot
```

```{r}
# Create subfolders for output files
outputs_folder <- "data/glycogen/Outputs"
if (!file.exists("data/glycogen/Outputs")) {
  dir.create("data/glycogen/Outputs", recursive = TRUE)
}

# Save data frames as CSV files in their output folders
write.csv(df_lum, file.path(outputs_folder,"CorPGA_Lum.csv"), row.names = FALSE)
write.csv(df_OD, file.path(outputs_folder, "CorPGA_OD.csv"), row.names = FALSE)


# Save the combined plot as a PNG file
ggsave(file.path(outputs_folder, "CorPGA_GlycogenPlots.png"), combined_plot, width = 10, height = 6, dpi = 300)

# Save the combined plot as a SVG file
ggsave(file.path(outputs_folder, "CorPGA_GlycogenPlots.svg"), combined_plot, width = 10, height = 6, dpi = 300)
```

# References {.unnumbered}

<div id="refs"></div>

<br>

<img src="images/Department-of-Molecular-Virology-&amp;-Microbiologyy-Horz-GRAY.png" align="left" width="240" height="110"/>

----------------------------------------------------------------------

----------------------------------------------------------------------

----------------------------------------------------------------------

----------------------------------------------------------------------













